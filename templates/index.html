<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">   
    <title>Expense Tracker</title>
    <style>
        .edit-mode .edit-field {
            display: inline-block;
        }
        .edit-mode .display-field {
            display: none;
        }
        .display-mode .edit-field {
            display: none;
        }
        .display-mode .display-field {
            display: inline-block;
        }
    </style>
    <script>
    function formatPrice(input) {
        const value = input.value;
        const decimalIndex = value.indexOf('.');
        if (decimalIndex !== -1) {
            const decimalPart = value.substring(decimalIndex + 1);
            if (decimalPart.length > 2) {
                input.value = value.substring(0, decimalIndex + 3);
            }
        }
    }

    function toggleEditMode(button) {
        const row = button.closest('tr');
        row.classList.toggle('edit-mode');
        row.classList.toggle('display-mode');
        
        if (row.classList.contains('edit-mode')) {
            button.textContent = 'Save';
            // Populate edit fields with current values
            row.querySelector('input[name="name"]').value = row.querySelector('.display-field[name="name"]').textContent;
            row.querySelector('input[name="category"]').value = row.querySelector('.display-field[name="category"]').textContent;
            row.querySelector('input[name="price"]').value = row.querySelector('.display-field[name="price"]').textContent.replace('£', '');
        } else {
            button.textContent = '✎';
            updateExpense(row);
        }
    }

    function updateExpense(row) {
        const id = row.dataset.id;
        const name = row.querySelector('input[name="name"]').value;
        const category = row.querySelector('input[name="category"]').value;
        const price = row.querySelector('input[name="price"]').value;

        fetch(`/update/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `name=${encodeURIComponent(name)}&category=${encodeURIComponent(category)}&price=${encodeURIComponent(price)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                row.querySelector('.display-field[name="name"]').textContent = name;
                row.querySelector('.display-field[name="category"]').textContent = category;
                row.querySelector('.display-field[name="price"]').textContent = `£${parseFloat(price).toFixed(2)}`;
                updateTotal();
            } else {
                alert('Failed to update expense. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    function updateTotal() {
        const priceSpans = document.querySelectorAll('.display-field[name="price"]');
        let total = 0;
        priceSpans.forEach(span => {
            total += parseFloat(span.textContent.replace('£', ''));
        });
        document.getElementById('total').textContent = `${total.toFixed(2)}`;
    }
    </script>
</head>
<body>
    <h1>Expense Tracker</h1>   

    <form method="POST" action="/add">
        <input type="text" name="name" placeholder="Expense Name" required>
        <input list="categories" name="category" placeholder="Select or Enter Category">
        <datalist id="categories">
            <option value="Food">
            <option value="Bills">
            <option value="Entertainment">
            <option value="Clothing">
        </datalist>
        <input type="number" step="0.01" name="price" id="price" placeholder="Price" required oninput="formatPrice(this)">
        <button type="submit">Add Expense</button>
    </form>
    
    <h2>Total: £<span id="total">{{ total }}</span></h2>
    
    <table>
        <thead>
            <tr>
                <th>Expense Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
            <tr class="display-mode" data-id="{{ expense.id }}">
                <td>
                    <span class="display-field" name="name">{{ expense.name }}</span>
                    <input class="edit-field" type="text" name="name">
                </td>
                <td>
                    <span class="display-field" name="category">{{ expense.category }}</span>
                    <input class="edit-field" type="text" name="category">
                </td>
                <td>
                    <span class="display-field" name="price">£{{ "%.2f"|format(expense.price / 100) }}</span>
                    <input class="edit-field" type="number" step="0.01" name="price" oninput="formatPrice(this)">
                </td>
                <td>
                    <button type="button" class="update-icon" onclick="toggleEditMode(this)">✎</button>
                    <form method="POST" action="{{ url_for('delete_expense', id=expense.id) }}" style="display: inline;">
                        <button type="submit" class="delete-icon">X</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>